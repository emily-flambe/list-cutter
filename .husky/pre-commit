#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit validation..."

# Change to workers directory
cd cloudflare/workers

echo "ğŸ“‹ Checking Wrangler version..."
WRANGLER_VERSION=$(npx wrangler --version 2>&1 | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
MAJOR_VERSION=$(echo $WRANGLER_VERSION | cut -d. -f1)

if [ "$MAJOR_VERSION" -lt 4 ]; then
    echo "âŒ Wrangler version $WRANGLER_VERSION is below required 4.0.0"
    echo "   Run: npm install wrangler@latest"
    exit 1
fi
echo "âœ… Wrangler $WRANGLER_VERSION (v4+ required)"

echo "ğŸ—ï¸  Running build..."
if ! npm run build; then
    echo "âŒ Build failed"
    exit 1
fi
echo "âœ… Build successful"

echo "ğŸ”§ Running basic TypeScript syntax check on src/ only..."
if ! npx tsc --noEmit --skipLibCheck --allowJs src/**/*.ts; then
    echo "âš ï¸  TypeScript issues found in src/ - proceeding as build succeeded"
    echo "   Run 'npx tsc --noEmit' to see full type issues"
else
    echo "âœ… TypeScript syntax valid"
fi

echo "ğŸ‰ Pre-commit validation passed!"
